<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>sr decks</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
<style>
:root {
    --bg: #1c1b1a;
    --bg-card: #272524;
    --bg-inset: #1f1e1d;
    --border: #3a3634;
    --border-focus: #6b6560;
    --text: #d4cfc9;
    --text-muted: #8a8480;
    --text-dim: #5c5753;
    --accent: #87CEAB;
    --correct: #5cb85c;
    --wrong: #d9534f;
    --flag: #f0c040;
    --tag: #8bb878;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg); color: var(--text); padding: 2rem;
    max-width: 800px; margin: 0 auto;
}
h1 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--accent); }
.deck-list { list-style: none; }
.deck-row {
    display: flex; align-items: center; padding: 0.55rem 0.6rem;
    border-bottom: 1px solid var(--border); transition: background 0.15s;
}
.deck-row:hover { background: var(--bg-card); }
.deck-arrow {
    width: 1.4rem; text-align: center; cursor: pointer;
    color: var(--text-muted); font-size: 0.75rem; flex-shrink: 0;
    user-select: none;
}
.deck-arrow:hover { color: var(--text); }
.deck-arrow.leaf { visibility: hidden; }
.deck-name {
    flex: 1; cursor: pointer; font-size: 0.9rem; padding: 0 0.4rem;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.deck-name:hover { color: var(--accent); }
.deck-name .ext { color: var(--text-dim); }
.deck-stats {
    font-size: 0.8rem; color: var(--text-muted); white-space: nowrap;
    margin-right: 0.8rem;
}
.deck-stats .due-count { color: var(--accent); font-weight: 600; }
.deck-stats .due-count.zero { color: var(--text-dim); font-weight: 400; }
.review-btn {
    padding: 0.25rem 0.65rem; border: 1px solid var(--accent); border-radius: 5px;
    background: rgba(135,206,171,0.1); color: var(--accent); font-size: 0.75rem;
    cursor: pointer; font-weight: 500; white-space: nowrap;
    transition: background 0.15s;
}
.review-btn:hover { background: rgba(135,206,171,0.2); }
.children { display: none; }
.children.open { display: block; }
#loading { color: var(--text-muted); }
#error { color: var(--wrong); display: none; margin-top: 1rem; }
</style>
</head>
<body>
<h1>Decks</h1>
<div id="loading">Loading...</div>
<ul class="deck-list" id="tree-root"></ul>
<div id="error"></div>
<script>
async function loadTree() {
    try {
        const r = await fetch('/api/tree');
        if (!r.ok) throw new Error(await r.text());
        const tree = await r.json();
        document.getElementById('loading').style.display = 'none';
        renderTree(tree, document.getElementById('tree-root'), 0);
    } catch(e) {
        document.getElementById('loading').style.display = 'none';
        const el = document.getElementById('error');
        el.textContent = e.message;
        el.style.display = 'block';
    }
}

function renderTree(nodes, parent, depth) {
    nodes.forEach(node => {
        const li = document.createElement('li');
        const row = document.createElement('div');
        row.className = 'deck-row';
        row.style.paddingLeft = (0.6 + depth * 1.2) + 'rem';

        // Arrow
        const arrow = document.createElement('span');
        arrow.className = 'deck-arrow' + (node.is_leaf ? ' leaf' : '');
        arrow.textContent = node.is_leaf ? '' : '\u25B6';

        // Name
        const name = document.createElement('span');
        name.className = 'deck-name';
        if (node.is_leaf) {
            const parts = node.name.split('.');
            if (parts.length > 1) {
                const ext = parts.pop();
                name.innerHTML = esc(parts.join('.')) + '<span class="ext">.' + esc(ext) + '</span>';
            } else {
                name.textContent = node.name;
            }
        } else {
            name.textContent = node.name;
        }

        // Stats
        const stats = document.createElement('span');
        stats.className = 'deck-stats';
        const dueClass = node.due > 0 ? 'due-count' : 'due-count zero';
        stats.innerHTML = node.active + ' cards &middot; <span class="' + dueClass + '">' + node.due + ' due</span>';

        // Review button
        const btn = document.createElement('button');
        btn.className = 'review-btn';
        btn.textContent = 'Review';
        btn.onclick = (e) => { e.stopPropagation(); startReview(node.path); };

        row.appendChild(arrow);
        row.appendChild(name);
        row.appendChild(stats);
        row.appendChild(btn);
        li.appendChild(row);

        // Children
        if (!node.is_leaf && node.children && node.children.length > 0) {
            const childUl = document.createElement('ul');
            childUl.className = 'children deck-list';
            renderTree(node.children, childUl, depth + 1);
            li.appendChild(childUl);

            const toggle = () => {
                const open = childUl.classList.toggle('open');
                arrow.textContent = open ? '\u25BC' : '\u25B6';
            };
            arrow.onclick = (e) => { e.stopPropagation(); toggle(); };
            name.onclick = (e) => { e.stopPropagation(); toggle(); };
        } else if (!node.is_leaf) {
            name.onclick = (e) => { e.stopPropagation(); startReview(node.path); };
        }

        if (node.is_leaf) {
            name.onclick = (e) => { e.stopPropagation(); startReview(node.path); };
        }

        parent.appendChild(li);
    });
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function startReview(path) {
    try {
        const r = await fetch('/api/review', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: path})
        });
        if (!r.ok) {
            const data = await r.json();
            alert(data.error || 'Failed to start review');
            return;
        }
        const data = await r.json();
        if (data.url) window.open(data.url, '_blank');
    } catch(e) { alert(e.message); }
}

loadTree();
</script>
</body>
</html>