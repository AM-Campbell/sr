<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>sr review</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
<style>
:root {
    --bg: #1c1b1a;
    --bg-card: #272524;
    --bg-inset: #1f1e1d;
    --border: #3a3634;
    --border-focus: #6b6560;
    --text: #d4cfc9;
    --text-muted: #8a8480;
    --text-dim: #5c5753;
    --accent: #87CEAB;
    --correct: #5cb85c;
    --wrong: #d9534f;
    --flag: #f0c040;
    --tag: #8bb878;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg); color: var(--text);
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh; padding: 2rem;
}
#progress {
    width: 100%; max-width: 600px; text-align: center;
    color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;
}
#card-container {
    width: 100%; max-width: 600px;
    background: var(--bg-card); border-radius: 8px;
    border: 1px solid var(--border);
    padding: 2rem; min-height: 300px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; user-select: none;
    transition: border-color 0.2s;
}
#card-container:hover { border-color: var(--border-focus); }
#card-container.flipped { cursor: default; }
#card-front, #card-back { width: 100%; text-align: center; }
#card-front { font-size: 1.3rem; line-height: 1.6; }
#card-back {
    display: none; margin-top: 1.5rem; padding-top: 1.5rem;
    border-top: 1px solid var(--border); font-size: 1.1rem; line-height: 1.5;
}
.flip-hint { color: var(--text-dim); font-size: 0.85rem; margin-top: 1rem; }
#controls { display: none; margin-top: 1.5rem; gap: 1rem; flex-wrap: wrap; justify-content: center; }
.grade-btn {
    padding: 0.7rem 2rem; border-radius: 6px;
    font-size: 1rem; cursor: pointer; font-weight: 600;
    transition: transform 0.1s, opacity 0.1s;
}
.grade-btn:hover { transform: scale(1.05); }
.grade-btn:active { transform: scale(0.97); }
#btn-wrong { background: rgba(217,83,79,0.15); color: var(--wrong); border: 1px solid var(--wrong); }
#btn-correct { background: rgba(92,184,92,0.15); color: var(--correct); border: 1px solid var(--correct); }
#feedback-row { display: none; margin-top: 0.8rem; gap: 0.5rem; justify-content: center; }
.fb-btn {
    padding: 0.4rem 0.8rem; border: 1px solid var(--border); border-radius: 6px;
    background: transparent; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;
}
.fb-btn:hover { border-color: var(--border-focus); color: var(--text); }
.fb-btn.selected { border-color: var(--accent); color: var(--accent); }
#undo-btn {
    margin-top: 1rem; padding: 0.4rem 1rem; border: 1px solid var(--border);
    border-radius: 6px; background: transparent; color: var(--text-muted);
    font-size: 0.8rem; cursor: pointer; display: none;
}
#undo-btn:hover { border-color: var(--border-focus); color: var(--text); }
#action-bar {
    display: none; margin-top: 1rem; gap: 0.5rem; justify-content: center;
}
.action-btn {
    padding: 0.4rem 0.8rem; border: 1px solid var(--border); border-radius: 6px;
    background: transparent; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;
}
.action-btn:hover { border-color: var(--border-focus); color: var(--text); }
#flag-btn.flagged { border-color: var(--flag); color: var(--flag); }
#done-msg { display: none; font-size: 1.3rem; color: var(--accent); margin-top: 2rem; }
#error-msg { color: var(--wrong); margin-top: 1rem; display: none; }
pre { text-align: left; background: var(--bg-inset); padding: 1rem; border-radius: 6px; overflow-x: auto; }
code { font-family: "JetBrains Mono", "Fira Code", monospace; }
#autograde-result {
    display: none; margin-top: 1rem; padding: 0.6rem 1.2rem;
    border-radius: 6px; font-weight: 600; font-size: 1rem; text-align: center;
}
#autograde-result.correct { background: rgba(92,184,92,0.15); color: var(--correct); border: 1px solid var(--correct); }
#autograde-result.wrong { background: rgba(217,83,79,0.15); color: var(--wrong); border: 1px solid var(--wrong); }
#btn-next {
    display: none; padding: 0.7rem 2rem; border-radius: 6px;
    font-size: 1rem; cursor: pointer; font-weight: 600;
    background: rgba(135,206,171,0.15); color: var(--accent); border: 1px solid var(--accent);
    transition: transform 0.1s, opacity 0.1s;
}
#btn-next:hover { transform: scale(1.05); }
#btn-next:active { transform: scale(0.97); }
</style>
</head>
<body>
<div id="progress"></div>
<div id="card-container" onclick="flipCard()">
    <div id="card-front">Loading...</div>
    <div id="card-back"></div>
    <div class="flip-hint" id="flip-hint">click to flip</div>
</div>
<div id="autograde-result"></div>
<div id="controls">
    <button class="grade-btn" id="btn-wrong" onclick="grade(0)">&#10008; Wrong</button>
    <button class="grade-btn" id="btn-correct" onclick="grade(1)">&#10004; Correct</button>
    <button class="grade-btn" id="btn-next" onclick="submitAutoGrade()">Next &#8594;</button>
</div>
<div id="feedback-row">
    <button class="fb-btn" data-fb="too_hard" onclick="setFeedback('too_hard')">too hard</button>
    <button class="fb-btn" data-fb="just_right" onclick="setFeedback('just_right')">just right</button>
    <button class="fb-btn" data-fb="too_easy" onclick="setFeedback('too_easy')">too easy</button>
</div>
<div id="action-bar">
    <button class="action-btn" id="flag-btn" onclick="toggleFlag()" title="Flag (f)">&#9873; Flag</button>
    <button class="action-btn" id="edit-btn" onclick="editCard()" title="Edit (e)">&#9998; Edit</button>
    <button class="action-btn" id="suspend-btn" onclick="suspendCard()" title="Suspend (s)">&#9208; Suspend</button>
</div>
<button id="undo-btn" onclick="undo()">&#8630; Undo</button>
<div id="done-msg">Session complete!</div>
<div id="error-msg"></div>
<script>
let sessionToken = null;
let currentFeedback = null;
let hasFlipped = false;
let hasCard = false;
let currentGradable = true;
let autoGradeResult = null;  // {grade, response} set by adapter JS
let currentFlags = [];

async function api(method, path, body) {
    const opts = {method, headers: {"Content-Type": "application/json"}};
    if (sessionToken) opts.headers["X-Session-Token"] = sessionToken;
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(path, opts);
    if (!r.ok) {
        const t = await r.text();
        throw new Error(t);
    }
    return r.json();
}

async function init() {
    try {
        const data = await api("GET", "/api/session");
        sessionToken = data.session_token;
        await loadNext();
    } catch(e) { showError(e.message); }
}

async function loadNext() {
    try {
        const data = await api("GET", "/api/next");
        if (data.done) {
            document.getElementById("card-container").style.display = "none";
            document.getElementById("controls").style.display = "none";
            document.getElementById("feedback-row").style.display = "none";
            document.getElementById("autograde-result").style.display = "none";
            document.getElementById("action-bar").style.display = "none";
            document.getElementById("done-msg").style.display = "block";
            hasCard = false;
            return;
        }
        currentGradable = data.gradable;
        autoGradeResult = null;
        currentFlags = data.flags || [];
        document.getElementById("card-front").innerHTML = data.front_html;
        document.getElementById("card-back").innerHTML = "";
        document.getElementById("card-back").style.display = "none";
        document.getElementById("controls").style.display = "none";
        document.getElementById("feedback-row").style.display = "none";
        document.getElementById("autograde-result").style.display = "none";
        document.getElementById("btn-next").style.display = "none";
        document.getElementById("btn-wrong").style.display = "";
        document.getElementById("btn-correct").style.display = "";
        document.getElementById("flip-hint").style.display = currentGradable ? "block" : "block";
        document.getElementById("card-container").classList.remove("flipped");
        document.getElementById("progress").textContent =
            `Reviewed: ${data.session_stats.reviewed} | Remaining: ${data.session_stats.remaining}`;
        document.getElementById("action-bar").style.display = "flex";
        updateFlagButton();
        hasFlipped = false;
        hasCard = true;
        currentFeedback = null;
        document.querySelectorAll(".fb-btn").forEach(b => b.classList.remove("selected"));
        document.getElementById("error-msg").style.display = "none";
    } catch(e) { showError(e.message); }
}

async function flipCard() {
    if (hasFlipped || !hasCard) return;
    try {
        const data = await api("POST", "/api/flip");
        document.getElementById("card-back").innerHTML = data.back_html;
        document.getElementById("card-back").style.display = "block";
        document.getElementById("flip-hint").style.display = "none";
        document.getElementById("card-container").classList.add("flipped");
        hasFlipped = true;
        if (!currentGradable) {
            // Non-gradable: just show Next
            document.getElementById("controls").style.display = "flex";
            document.getElementById("btn-wrong").style.display = "none";
            document.getElementById("btn-correct").style.display = "none";
            document.getElementById("btn-next").style.display = "";
        } else {
            document.getElementById("controls").style.display = "flex";
            document.getElementById("feedback-row").style.display = "flex";
        }
    } catch(e) { showError(e.message); }
}

// Global hook for adapter JS to call for autograding
// Flow: adapter calls srAutoGrade() → core flips card, shows back + result → user clicks Next
window.srAutoGrade = async function(grade, response) {
    if (!hasCard || autoGradeResult) return;
    autoGradeResult = {grade: grade, response: response || null};

    // Flip the card to show the back
    if (!hasFlipped) {
        try {
            const data = await api("POST", "/api/flip");
            document.getElementById("card-back").innerHTML = data.back_html;
            document.getElementById("card-back").style.display = "block";
            document.getElementById("flip-hint").style.display = "none";
            document.getElementById("card-container").classList.add("flipped");
            hasFlipped = true;
        } catch(e) { showError(e.message); return; }
    }

    // Show result indicator
    const el = document.getElementById("autograde-result");
    el.className = grade === 1 ? "correct" : "wrong";
    el.textContent = grade === 1 ? "✓ Correct" : "✗ Wrong";
    el.style.display = "block";

    // Show Next button (hide correct/wrong buttons)
    document.getElementById("controls").style.display = "flex";
    document.getElementById("btn-wrong").style.display = "none";
    document.getElementById("btn-correct").style.display = "none";
    document.getElementById("btn-next").style.display = "";
    document.getElementById("feedback-row").style.display = "flex";
};

async function submitAutoGrade() {
    if (autoGradeResult) {
        // Autograded card — submit the adapter's grade
        try {
            await api("POST", "/api/grade", {
                grade: autoGradeResult.grade,
                feedback: currentFeedback,
                response: autoGradeResult.response
            });
            document.getElementById("undo-btn").style.display = "inline-block";
            await loadNext();
        } catch(e) { showError(e.message); }
    } else {
        // Non-gradable card — just move on, no grade logged
        try {
            await api("POST", "/api/skip");
            await loadNext();
        } catch(e) { showError(e.message); }
    }
}

async function grade(g) {
    try {
        await api("POST", "/api/grade", {grade: g, feedback: currentFeedback});
        document.getElementById("undo-btn").style.display = "inline-block";
        await loadNext();
    } catch(e) { showError(e.message); }
}

function setFeedback(fb) {
    currentFeedback = (currentFeedback === fb) ? null : fb;
    document.querySelectorAll(".fb-btn").forEach(b => {
        b.classList.toggle("selected", b.dataset.fb === currentFeedback);
    });
}

async function undo() {
    try {
        const data = await api("POST", "/api/undo");
        if (data.ok) {
            document.getElementById("done-msg").style.display = "none";
            document.getElementById("card-container").style.display = "flex";
            document.getElementById("card-front").innerHTML = data.front_html;
            document.getElementById("card-back").innerHTML = data.back_html;
            document.getElementById("card-back").style.display = "block";
            document.getElementById("controls").style.display = "flex";
            document.getElementById("feedback-row").style.display = "flex";
            document.getElementById("flip-hint").style.display = "none";
            document.getElementById("card-container").classList.add("flipped");
            document.getElementById("autograde-result").style.display = "none";
            document.getElementById("btn-next").style.display = "none";
            document.getElementById("btn-wrong").style.display = "";
            document.getElementById("btn-correct").style.display = "";
            hasFlipped = true;
            hasCard = true;
            autoGradeResult = null;
            document.getElementById("undo-btn").style.display = "none";
        }
    } catch(e) { showError(e.message); }
}

function updateFlagButton() {
    const btn = document.getElementById("flag-btn");
    const isFlagged = currentFlags.some(f => f.flag === "edit_later");
    btn.classList.toggle("flagged", isFlagged);
    btn.innerHTML = isFlagged ? "&#9873; Flagged" : "&#9873; Flag";
}

async function toggleFlag() {
    if (!hasCard) return;
    const isFlagged = currentFlags.some(f => f.flag === "edit_later");
    try {
        const endpoint = isFlagged ? "/api/unflag" : "/api/flag";
        const data = await api("POST", endpoint, {flag: "edit_later"});
        currentFlags = data.flags || [];
        updateFlagButton();
    } catch(e) { showError(e.message); }
}

async function editCard() {
    if (!hasCard) return;
    try {
        await api("POST", "/api/edit");
    } catch(e) { showError(e.message); }
}

async function suspendCard() {
    if (!hasCard) return;
    try {
        await api("POST", "/api/suspend");
        document.getElementById("undo-btn").style.display = "inline-block";
        await loadNext();
    } catch(e) { showError(e.message); }
}

function showError(msg) {
    const el = document.getElementById("error-msg");
    el.textContent = msg;
    el.style.display = "block";
}

document.addEventListener("keydown", (e) => {
    if (e.key === " " && !hasFlipped && hasCard) { e.preventDefault(); flipCard(); }
    else if (e.key === "Enter" && hasFlipped && (autoGradeResult || !currentGradable)) submitAutoGrade();
    else if (e.key === "1" && hasFlipped && !autoGradeResult && currentGradable) grade(0);
    else if (e.key === "2" && hasFlipped && !autoGradeResult && currentGradable) grade(1);
    else if (e.key === "f" && hasCard) toggleFlag();
    else if (e.key === "e" && hasCard) editCard();
    else if (e.key === "s" && hasCard) suspendCard();
    else if (e.key === "z" || e.key === "u") undo();
});

init();
</script>
</body>
</html>